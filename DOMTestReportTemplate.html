{% extends "html1/base.html" %}
{% block content %}
<section id="test-files">
  <div class="container">
    <h1>Tests</h1>
    {% for fspath, tests in tests|groupby('item.fspath') %}
      {% set first_item = tests|map(attribute='item')|first %}
      <details class="file" open="">
        <summary>
          <h2 class="title file-title">
            {% block module_title scoped %}
            <span class="fspath">
              {% block module_name scoped %}
              {{ first_item.nodeid.split('::')|first }}
              {% endblock %}
            </span>
            <span class="counts">
            {% for category, tests in tests|groupby('status.category') -%}
              <span title="{{ tests|count }} {{ category }}" class="count status badge {{ category }} {{ tests|map(attribute='status.style')|first|join(' ') }}">{{ tests|count }}</span>
            {%- endfor %}
            </span>
            <span class="duration">
              {{ tests|map(attribute='phases')|map('sum', 'report.duration')|sum|timedelta }}
            </span>
            {% endblock %}
          </h2>
        </summary>
        <div class="content box">
            {% block module_content scoped %}
            {% for test in tests %}
              <details class="test {{ test.status.category }}">
                <summary>
                  <h3 class="title test-title">
                    {% block test_title scoped %}
                    <span class="status badge {{ test.status.category }} {{ test.status.style|join(' ') }}">
                      {{ test.status.word }}
                      {% for phase in test.phases if phase.call and phase.call.excinfo %}
                      {{ phase.call.excinfo.value.args[0] }}
                      {% endfor %}
                    </span>
                    <span class="test-name">
                      {% block test_name scoped %}
                      {% set name = test.item.nodeid.split('::')[1:]|join('::') %}
                      {% set funcname, _, params = name.partition('[') %}
                      <span class="funcname">{{ funcname }}</span>
                      {%- if params -%}
                        <span class="params">[{{ params }}</span>
                      {% endif %}
                      {% endblock %}
                    </span>
                    <span class="duration">{{ test.phases|sum('report.duration')|timedelta }}</span>
                    {% endblock %}
                  </h3>
                </summary>
                <div class="content">
                  {% for phase in test.phases if phase.call %}
                    {% for section, content in phase.sections %}
                      <pre><samp>{{ content|escape|replace('\r\n', '\n')|ansi|safe }}</samp></pre>
                    {% endfor %}
                  {% endfor %}
                </div>
              </details>
            {% endfor %}
            {% endblock %}
        </div>
      </details>
    {% endfor %}
  </div>
</section>
{% endblock %}
